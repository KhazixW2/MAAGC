# MAAGC 战斗系统开发文档

## 概述

本文档记录 MAAGC 战斗系统的开发过程，包括任务信息提取、OCR 结果处理、节日活动检测等功能模块的实现。

## 模块结构

```
agent/
├── action/
│   ├── fight/
│   │   ├── fight_processor.py   # 战斗处理器主逻辑
│   │   └── fight_utils.py        # 战斗工具函数
│   └── zshg/
│       └── task_extractor.py     # 任务信息提取器
├── main.py                       # 程序入口
assets/
├── interface.json                # MaaFramework 接口配置
└── task_names.json               # 已知任务名称列表
```

## 功能模块

### 1. 任务信息提取器 (TaskExtractor)

#### 功能说明

从 OCR 识别结果中提取任务信息，包括：

- 任务名称
- 任务描述
- 奖励内容
- 时间限制
- 敌人等级
- 接受按钮位置
- 放弃按钮位置

#### 核心类定义

```python
@dataclass
class TaskInfo:
    task_name: str
    task_description: str
    reward: Optional[str] = None
    time_limit: Optional[str] = None
    enemy_level: Optional[str] = None
    accept_button_box: Optional[Rect] = None
    abandon_button_box: Optional[Rect] = None
```

#### 关键方法

- `extract_tasks(ocr_results)`: 从 OCR 结果中提取所有任务
- `print_task_details(tasks)`: 打印任务详细信息
- `_group_by_y_position()`: 按 Y 坐标对 OCR 结果进行空间分组
- `_extract_single_task(ocr_results)`: 提取单个任务的详细信息

#### 动态任务名称识别

任务提取器支持动态识别任务名称：

1. 根据文本长度和位置判断任务名称
2. 将识别到的任务名称保存到 `task_names.json`
3. 后续运行时从本地文件加载已知任务名称

#### 按钮处理

支持识别两种按钮：

- **接受按钮**: 任务未接取时显示
- **放弃按钮**: 任务已接取时显示

---

### 2. 战斗处理器 (FightProcessor)

#### 前处理操作

在正式战斗流程开始前，需要检查并处理以下随机事件：

| 序号 | 事件类型 | 说明 |
|------|----------|------|
| 1 | 佣兵加入事件 | 随机佣兵申请加入队伍 |
| 2 | 佣兵生娃事件 | 已有佣兵生育新成员 |
| 3 | 退休事件 | 佣兵申请退休离开队伍 |
| 4 | 其他额外事件 | 其他随机触发的特殊事件 |

#### 前处理流程

```
[开始前处理]
    │
    ├─► 循环检测（最多10次）
    │       │
    │       ├─► 截取屏幕
    │       │
    │       ├─► 识别事件类型
    │       │       │
    │       │       ├─► 佣兵加入 → 处理加入逻辑 → 返回继续检测
    │       │       │
    │       │       ├─► 佣兵生娃 → 处理生育逻辑 → 返回继续检测
    │       │       │
    │       │       ├─► 退休确认 → 处理退休逻辑 → 返回继续检测
    │       │       │
    │       │       └─► 无事件 → 结束前处理，进入主流程
    │       │
    │       └─► 处理事件
    │
    └─► [进入节日活动检测]
```

#### 核心方法

- `_preprocess_events(context)`: 前处理主循环，检测并处理随机事件
- `_detect_event(screenshot)`: 识别当前屏幕的事件类型
- `_handle_event(context, event_type)`: 处理具体事件逻辑

#### 节日活动检测

根据当前游戏月份自动检测并处理节日活动：

| 月份 | 节日 | 处理方式 |
|------|------|----------|
| 2月 | 祈灵日 | 不过 |
| 3月 | 启航节 | 必过，需要进入对应城市 |
| 5月 | 春林节 | 不过 |
| 6月 | 铸魂节 | 不过 |
| 8月 | 丰收节 | 必过 |
| 10月 | 勇士节 | 顺路才过（需要检查当前国家） |
| 11月 | 亡人节 | 不过 |
| 12月 | 创元节 | 不过 |

#### 处理流程

```
1. 前处理：检测并处理随机事件
   ├─► 佣兵加入事件
   ├─► 佣兵生娃事件
   ├─► 退休事件
   └─► 其他额外事件

2. 检查游戏界面

3. 检测当前月份（尝试 12 次）

4. 根据月份处理节日活动

5. 接取主城任务
```

### 3. 战斗工具函数 (fight_utils.py)

#### 整体流程

任务流程分为三个主要阶段：

```
[主流程 start_task]
    │
    ├─► 阶段 1: 前处理 - 接取任务
    │       │
    │       ├─► 1.1 检测大地图界面
    │       │
    │       ├─► 1.2 移动到主城
    │       │
    │       ├─► 1.3 打开任务面板
    │       │
    │       ├─► 1.4 检测是否已接取任务
    │       │       │
    │       │       ├─► 已接取 → 返回，执行战斗阶段
    │       │       │
    │       │       └─► 未接取 → 执行 1.5
    │       │
    │       └─► 1.5 识别并接取新任务
    │
    ├─► 阶段 2: 战斗部分
    │       │
    │       ├─► 2.1 打开任务列表
    │       │
    │       ├─► 2.2 快速定位任务点
    │       │
    │       ├─► 2.3 前往任务点
    │       │
    │       └─► 2.4 执行战斗循环
    │
    └─► 阶段 3: 后处理 - 战后结算
            │
            └─► 3.1 确认战斗结果
```

#### 核心函数

| 函数名 | 功能 |
|--------|------|
| `start_task(context)` | 主入口，调度三个阶段 |
| `check_task_accepted_in_list(context)` | 检测任务列表中是否已接取任务 |
| `_preprocess_accept_task(context)` | 前处理：接取任务 |
| `_accept_new_task(context)` | 接取新任务 |
| `_process_fight(context)` | 战斗阶段 |
| `_postprocess_battle(context)` | 后处理：结算 |

#### 任务接取判断逻辑

通过识别 `TaskQuickLocation` 图标判断是否已接取任务：
- **已接取**：显示快速定位图标 → 跳过接取步骤，直接执行战斗
- **未接取**：无快速定位图标 → 执行接取任务流程

---

## 战斗体系开发状态

### 已完成功能

#### 1. fight_processor.py (主控制器)

| 功能 | 状态 | 说明 |
|------|------|------|
| 游戏界面检测 | ✅ 完成 | 检测是否在大地图界面 |
| 月份识别 | ✅ 完成 | 循环12次识别当前月份 |
| 前处理-随机事件检测 | ✅ 完成 | `_preprocess_events()` 循环检测最多10次 |
| 前处理-佣兵加入事件 | ✅ 完成 | `_detect_event()` + `_handle_event()` |
| 前处理-佣兵生娃事件 | ✅ 完成 | `_detect_event()` + `_handle_event()` |
| 前处理-退休事件 | 🔶 待实现 | 代码已预留，需配置 `Event_Retire` 识别 |
| 节日检测-启航节(3月) | 🔶 待实现 | 方法已创建 `_handle_sailing_festival()` |
| 节日检测-丰收节(8月) | 🔶 待实现 | 方法已创建 `_handle_harvest_festival()` |
| 节日检测-勇士节(10月) | 🔶 待实现 | 方法已创建 `_handle_warrior_festival()` |
| 任务接取 | 🔶 待实现 | 调用 `fight_utils.start_task()` |

#### 2. fight_utils.py (任务工具函数)

| 功能 | 状态 | 说明 |
|------|------|------|
| 月份检测 | ✅ 完成 | `Map_CheckCurrentMonth()` |
| 任务接取状态检测 | ✅ 完成 | `check_task_accepted_in_list()` |
| 任务流程主入口 | ✅ 完成 | `start_task()` |
| 阶段1-前处理接取任务 | ✅ 完成 | `_preprocess_accept_task()` |
| 阶段1-识别并接取新任务 | ✅ 完成 | `_accept_new_task()` |
| 阶段2-战斗流程 | ✅ 完成 | `_process_fight()` |
| 阶段3-战后结算 | ✅ 完成 | `_postprocess_battle()` |

### 待实现功能清单

#### 高优先级

1. **调用任务接取**
   - `fight_processor.py` 中调用 `fight_utils.start_task()`
   - 目前已注释：`# fight_utils.start_task(context)`

2. **节日活动处理**
   - 启航节(3月)：进入对应城市
   - 丰收节(8月)：执行丰收节流程
   - 勇士节(10月)：检查当前国家后决定是否过

3. **退休事件处理**
   - 取消注释 `Event_Retire` 检测代码
   - 配置识别任务

#### 中优先级

4. **战斗循环优化**
   - 紫砂小盾配置
   - 一键跳过回合

5. **战后结算完善**
   - 胜利：获取奖励
   - 失败：记录日志、重试逻辑

6. **任务选择逻辑**
   - 目前固定选择第一个任务
   - 后续可增加优先级选择（紧急任务 > 普通任务）

### 整体流程图（当前状态）

```
[TaskProcessor.run]
    │
    ├─► 1. 检测大地图界面 ✅
    │
    ├─► 2. 前处理：随机事件
    │       ├─► 佣兵加入 ✅
    │       ├─► 佣兵生娃 ✅
    │       └─► 退休 🔶
    │
    ├─► 3. 检测当前月份 ✅
    │
    ├─► 4. 节日处理
    │       ├─► 启航节(3月) 🔶
    │       ├─► 丰收节(8月) 🔶
    │       └─► 勇士节(10月) 🔶
    │
    └─► 5. 接取任务 🔶 (待调用 start_task)
            │
            ├─► 阶段1: 前处理-接取任务 ✅
            │       └─► 检测已接取 → 未接取则接取
            │
            ├─► 阶段2: 战斗部分 ✅
            │       └─► 寻找任务点 → 战斗循环
            │
            └─► 阶段3: 后处理 ✅
                    └─► 确认战斗结果
```

### 后续开发计划

1. 完善节日活动处理逻辑
2. 实现战斗循环和紫砂小盾配置
3. 增加任务选择优先级
4. 完善战后结算逻辑

---

### 3. 接口配置 (interface.json)

#### 规范说明

按照 MaaFramework Project Interface V2 协议配置，核心字段：

```json
{
    "task_name": {
        "algorithm": "Ocr",
        "expected": ["任务名称"],
        "roi": [x, y, w, h]
    }
}
```

#### 注意事项

- 不能包含 JSON 注释
- 字段名使用 `description` 而非 `doc`
- 确保文件路径引用正确

---

## 常见问题与修复

### 1. 导入错误

**问题**: `No module named 'task_extractor'`

**解决**: 修改导入路径

```python
# 错误
from task_extractor import TaskExtractor

# 正确
from action.zshg.task_extractor import TaskExtractor
```

### 2. 数据格式处理

**问题**: `'list' object has no attribute 'y'`

**解决**: 添加辅助方法处理不同数据格式

- `_get_box_y()`: 获取 Box 的 Y 坐标
- `_get_box()`: 获取 Box 对象
- `_get_text()`: 获取文本内容
- `_get_box_from_result()`: 从结果中提取 Box

### 3. 任务合并问题

**问题**: 多个任务被识别为同一个

**解决**: 调整 Y 坐标间距阈值

- 将阈值从 100 调整为 150 像素

### 4. Ctrl+C 无法退出

**解决**: 添加信号处理

```python
import signal
import sys

def signal_handler(sig, frame):
    logger.info("收到退出信号，正在关闭...")
    sys.exit(0)

signal.signal(signal.SIGINT, signal_handler)
```

### 5. ONNX Runtime 警告

**解决**: 升级库版本

```bash
pip install --upgrade onnxruntime
```

---

## 日志级别说明

| 级别 | 用途 |
|------|------|
| DEBUG | 详细调试信息 |
| INFO | 一般流程信息 |
| WARNING | 警告信息 |
| ERROR | 错误信息 |

---

## 配置文件

### task_names.json

存储已知任务名称，示例：

```json
["观察者", "夺心者"]
```

### interface.json

MaaFramework 任务识别配置，详见上文接口配置部分。

---

## 开发规范

1. 代码注释使用中文
2. 遵循 PEP 8 代码风格
3. 保持函数功能单一性
4. 做好异常处理和日志记录
